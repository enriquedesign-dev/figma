# Figma Text API Backend

A lightweight FastAPI backend that integrates with the Figma API to serve JSON files containing text content for mobile applications. The system fetches text nodes from Figma design files and organizes them by Pages → Screens → Texts with positional information.

## Features

- **FastAPI Backend**: High-performance async API server
- **Figma Integration**: Fetches design data directly from Figma API
- **SQLite Database**: Lightweight database for storing JSON text data
- **Automated Sync**: Background synchronization with Figma files
- **RESTful API**: Clean endpoints for mobile app consumption
- **Text Organization**: Structured data as Page → Screen → Text hierarchy
- **Reading Order**: Texts automatically sorted by `axis_y` (top to bottom) for logical flow

## Architecture

The system's architecture is designed for decoupling and efficiency. A synchronization service pulls data from Figma and stores it in a local database, which is then served to clients by a high-performance FastAPI server.

```
                            +-----------------+
                            |   Figma API     |
                            +-----------------+
                                    |
            (1. Manual/Scheduled Sync) |
                                    v
+--------------------------------------------------------------------------+
| Backend System                                                           |
|                                                                          |
|   +-----------------+        +-----------------+       +-----------------+  |
|   |  Sync Service   |----(2)->| SQLite Database |<--(3)--|  FastAPI Server |  |
|   | (sync_service.py)|        | (mobile_app_data.db)|   |    (main.py)    |  |
|   +-----------------+        +-----------------+       +-----------------+  |
|                                                                          |
+--------------------------------------------------------------------------+
                                                                   ^
                                                                   | (4. API Request)
                                                                   |
                                                        +----------------------+
                                                        | Mobile App (Client)  |
                                                        | (iOS / Android)      |
                                                        +----------------------+
```

### Data Flow

1.  **Synchronization**: The **Sync Service** is triggered, either manually or via a scheduled job. It calls the **Figma API** to fetch the entire design file.
2.  **Data Storage**: The service parses the Figma file, extracts all text nodes, organizes them into a structured format (`Page > Screen > Text`), and stores the result in the **SQLite Database**. This decouples the API from Figma's availability and improves performance.
3.  **Data Retrieval**: The **FastAPI Server** reads the structured data directly from the SQLite database when it receives a request from a client.
4.  **API Consumption**: A **Mobile App** (or any other client) makes a request to a specific endpoint on the FastAPI server to get the texts it needs, either as a structured JSON object or as a formatted localization file.

## Installation

1. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Set up environment variables:**
   ```bash
   # Copy example env file
   cp .env.example .env
   
   # Edit .env with your Figma credentials
   FIGMA_ACCESS_TOKEN=your_figma_token
   FIGMA_FILE_KEY=your_figma_file_key
   ```

3. **Run the application:**
   ```bash
   python main.py
   ```

## API Endpoints

### Health Check
```
GET /health
```
Returns API health status and configuration check.

### Sync Figma Data
```
POST /api/sync
```
Synchronizes text data from the default Figma file to database.

### Get Complete File Data
```
GET /api/figma/data
```
Returns complete organized text data for the default Figma file.

### Get Pages List
```
GET /api/figma/pages
```
Returns list of pages in the default Figma file.

### Get Page Data
```
GET /api/figma/pages/{page_name}
```
Returns all screens and texts for a specific page from the default Figma file.

### Get Screen Data
```
GET /api/figma/pages/{page_name}/screens/{screen_name}
```
Returns all texts for a specific screen from the default Figma file.

### Localization Endpoints

The API can generate localization files directly from your Figma pages, making it easy to integrate with mobile development workflows. Keys are automatically generated by combining screen and text layer names (e.g., `screen_name_text_name`).

#### iOS (JSON)
```
GET /api/figma/ios/{page_name}/{language}
```
Returns a structured JSON file for a specific page. The `{language}` parameter is for path compatibility; the text content is sourced directly from Figma. The response includes a version (based on the last sync time) and an HMAC-SHA256 signature to verify data integrity.

**Response format for `GET /api/figma/ios/home/es`:**
```json
{
  "version": 1672531200,
  "signature": "BASE64-HMAC-SHA256==",
  "strings": {
    "home.welcome": "¡Bienvenido!",
    "home.balance": "Saldo actual",
    "home.logout": "Cerrar sesión"
  }
}
```

#### Android (XML)
```
GET /api/figma/android/{page_name}/{language}
```
Returns an Android-compatible `strings.xml` file for a specific page. The `{language}` parameter is for path compatibility.

**Response format for `GET /api/figma/android/home/es`:**
```xml
<resources>
    <string name="home_welcome">¡Bienvenido!</string>
    <string name="home_balance">Saldo actual</string>
    <string name="home_logout">Cerrar sesión</string>
</resources>
```

### Get Default File Texts
```
GET /api/figma/texts
```
Returns all texts from the default Figma file (uses `FIGMA_FILE_KEY` from environment variables). This endpoint flattens all texts across all pages and screens for easy consumption by mobile applications.

**Response format:**
```json
{
  "total_texts": 5,
  "pages": {
    "Onboarding": {
      "1-informacion-salarial-default": {
        "01_Title": {
          "text_content": "Información salarial",
          "axis_x": 527.0,
          "axis_y": 84.0,
          "page_id": "0:1",
          "screen_id": "16:425"
        },
        "02_Subtitle": {
          "text_content": "Esto nos permitirá ofrecer mejores beneficios para ti",
          "axis_x": 527.0,
          "axis_y": 129.0,
          "page_id": "0:1",
          "screen_id": "16:425"
        },
        "03_Field label": {
          "text_content": "Tipo de ingreso",
          "axis_x": 519.0,
          "axis_y": 341.0,
          "page_id": "0:1",
          "screen_id": "16:425"
        }
      }
    }
  },
  "last_updated": "2024-01-01T12:00:00"
}
```

## JSON Data Structure

The API returns text data organized in the following structure:

```json
{
  "pages": {
    "Page Name": {
      "page_id": "figma_page_id",
      "screens": {
        "Screen Name": {
          "screen_id": "figma_screen_id",
          "texts": [
            {
              "name": "Text Layer Name",
              "content": "Actual text content",
              "axis_x": 100.0,
              "axis_y": 200.0
            }
          ]
        }
      }
    }
  },
  "last_updated": "2024-01-01T12:00:00",
  "figma_file_key": "file_key"
}
```

## Synchronization

### Manual Sync
Run the standalone sync script:
```bash
python sync_script.py
```

### Automated Sync
Set up a cron job for regular synchronization:
```bash
# Edit crontab
crontab -e

# Add line for hourly sync
0 * * * * cd /path/to/project && python sync_script.py
```

## Configuration

### Environment Variables

| Variable | Description | Required |
|----------|-------------|----------|
| `FIGMA_ACCESS_TOKEN` | Figma API access token | Yes |
| `FIGMA_FILE_KEY` | Default Figma file key | Yes |
| `HMAC_SECRET_KEY` | A secure secret key for generating HMAC signatures for localization endpoints. | No |
| `DATABASE_URL` | SQLite database path | No |
| `HOST` | API server host | No |
| `PORT` | API server port | No |

### Figma Setup

1. **Get Access Token:**
   - Go to Figma → Settings → Account → Personal Access Tokens
   - Generate new token with appropriate permissions

2. **Get File Key:**
   - Copy from Figma file URL: `https://www.figma.com/file/{FILE_KEY}/...`


## Development

### Running Locally
```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export FIGMA_ACCESS_TOKEN="your_token"
export FIGMA_FILE_KEY="your_file_key"

# Run development server
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Database Schema

The system uses two main tables:

- **figma_pages**: Stores complete page JSON data
- **figma_texts**: Stores individual text entries for fast querying

## Deployment

### Production Setup

1. **Use environment variables for configuration**
2. **Set up reverse proxy (nginx)**
3. **Configure automated sync via cron**
4. **Monitor API health endpoint**
